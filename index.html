<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live GPS Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    html, body, #map { height:100%; margin:0; padding:0; }
    #controls {
      position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
      background:rgba(255,255,255,0.9); padding:8px; border-radius:4px;
      display:flex; gap:8px; z-index:5;
    }
    #controls button, #controls input { font-size:14px; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <button id="play">Play</button>
    <button id="pause">Pause</button>
    <input id="slider" type="range" min="0" max="0" value="0" style="width:300px"/>
  </div>
  <script>
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzUuSXVnDgNVmR3lVH9X2ovAeahJnSWCe6oQXzxPGEefBCq-AL0pMMb853zApv7KNDa/exec';
    const INITIAL_ZOOM = 12;
    const CENTER = { lat:36.3526, lng:-94.2755 };

    let map, markers = {}, trailPaths = {}, trailData = [];
    let trailPolyline, playbackMarker, playbackInterval;

    // Initialize map & load data
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center:CENTER, zoom:INITIAL_ZOOM, mapTypeId:'hybrid'
      });
      fetchData();
      setInterval(fetchData, 10000);
      document.getElementById('play').onclick = startPlayback;
      document.getElementById('pause').onclick = pausePlayback;
    }

    // Fetch full trail + markers
    async function fetchData() {
      try {
        const res = await fetch(`${ENDPOINT}?json=true&t=${Date.now()}`);
        const pts = await res.json();
        if (!Array.isArray(pts)) return;
        trailData = pts;

        // 1) Draw trail polyline
        const path = pts.map(p=>({ lat:p.lat, lng:p.lon }));
        if (!trailPolyline) {
          trailPolyline = new google.maps.Polyline({
            path, strokeColor:'#00BFFF', strokeOpacity:0.7, strokeWeight:3, map
          });
        } else {
          trailPolyline.setPath(path);
        }

        // 2) Update markers for latest position per device
        const latest = {};
        pts.forEach(p => latest[p.device] = p);
        Object.keys(latest).forEach(d => {
          const p = latest[d];
          const pos = { lat:p.lat, lng:p.lon };
          if (markers[d]) {
            markers[d].setPosition(pos);
          } else {
            markers[d] = new google.maps.Marker({
              position:pos, map, title:d,
              icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            });
            markers[d].addListener('click', ()=>{
              new google.maps.InfoWindow()
                .setContent(`<strong>${d}</strong><br>${new Date(p.timestamp).toLocaleString()}`)
                .open(map, markers[d]);
            });
          }
        });

        // 3) Setup slider range
        const slider = document.getElementById('slider');
        slider.max = trailData.length - 1;
        slider.oninput = ()=>{
          const i = +slider.value;
          movePlaybackMarker(i);
        };

      } catch (err) {
        console.error('Error fetching data:',err);
      }
    }

    // Playback functions
    function startPlayback() {
      if (playbackInterval) return;
      if (!playbackMarker) {
        playbackMarker = new google.maps.Marker({
          map, icon:'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
        });
      }
      let i = +document.getElementById('slider').value;
      playbackInterval = setInterval(()=>{
        if (i >= trailData.length) return pausePlayback();
        movePlaybackMarker(i);
        document.getElementById('slider').value = i;
        i++;
      }, 500);
    }
    function pausePlayback() {
      clearInterval(playbackInterval);
      playbackInterval = null;
    }
    function movePlaybackMarker(i) {
      const p = trailData[i];
      const pos = { lat:p.lat, lng:p.lon };
      playbackMarker.setPosition(pos);
      map.panTo(pos);
    }

    window.onload = initMap;
  </script>
</body>
</html>


