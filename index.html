<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Angler Tracker</title>
  <meta name="viewport" content="initial-scale=1.0,user-scalable=no"/>
  <style>
    html, body, #map { margin:0; padding:0; width:100%; height:100%; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIfCWstMFLCiR9VJMS6lePKoytUgy1qPY"></script>
</head>
<body>
  <div id="map"></div>
  <script>
    const ENDPOINT     = 'https://script.google.com/macros/s/AKfycbwgu-hYl5R4-7jHlFj78lX0kTZWtqHEEwVDxf7bYgFSYXA3uOONgm1wxwgkhU9FAD08/exec';
    const INITIAL_ZOOM = 12;
    const CENTER_FALLBACK = { lat: 36.3526, lng: -94.2755 };

    let map, marker, infoWindow;
    let firstLoad = true;

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: CENTER_FALLBACK,
        zoom: INITIAL_ZOOM,
        mapTypeId: 'hybrid',
        disableDefaultUI: false,
        gestureHandling: 'greedy'
      });
      infoWindow = new google.maps.InfoWindow();
      fetchAndPlot();
      setInterval(fetchAndPlot, 10000);
    }

    async function fetchAndPlot() {
      const res = await fetch(`${ENDPOINT}?json=true&limit=1&t=${Date.now()}`);
      const arr = await res.json();
      if (!arr.length) return;
      const pt = arr[0];
      const pos = { lat: pt.latitude, lng: pt.longitude };

      // Custom icon with proper anchor and labelOrigin
      const icon = {
        url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
        scaledSize: new google.maps.Size(48, 48),
        anchor: new google.maps.Point(24, 48),
        labelOrigin: new google.maps.Point(24, 0)
      };

      if (marker) {
        marker.setPosition(pos);
      } else {
        marker = new google.maps.Marker({
          position: pos,
          map,
          icon: icon,
          label: {
            text: pt.device,
            color: '#ffffff',
            fontSize: '14px',
            fontWeight: 'bold'
          }
        });
        marker.addListener('click', () => showInfo(pt, marker));
      }

      if (firstLoad) {
        map.setCenter(pos);
        map.setZoom(INITIAL_ZOOM);
        firstLoad = false;
      }

      showInfo(pt, marker);
    }

    function showInfo(pt, marker) {
      infoWindow.setContent(`
        <div style="font-size:14px">
          <strong>${pt.device}</strong><br>
          ${new Date(pt.timestamp).toLocaleString()}
        </div>`);
      infoWindow.open(map, marker);
    }

    window.onload = initMap;
  </script>
</body>
</html>
