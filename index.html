<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Angler Tracker + Trail Playback</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
  <style>
    html, body, #map { margin:0; padding:0; width:100%; height:100%; }
    .sidebar {
      position: absolute;
      top: 60px; left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      z-index: 5;
      font-family: Arial;
      font-size: 14px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .sidebar select, .sidebar button {
      margin-top: 5px;
      width: 100%;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIfCWstMFLCiR9VJMS6lePKoytUgy1qPY"></script>
</head>
<body>
  <div id="map"></div>
  <div class="sidebar">
    <button onclick="toggleTrail()">Toggle Trail</button>
    <button onclick="fitBounds()">Fit Bounds</button>
    <button onclick="togglePlayback()">Play/Pause Trail</button>
    <input type="range" id="timeSlider" min="0" max="100" value="0" style="width:100%" oninput="sliderMoved()" />
  </div>

  <script>
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzUuSXVnDgNVmR3lVH9X2ovAeahJnSWCe6oQXzxPGEefBCq-AL0pMMb853zApv7KNDa/exec';
    const INITIAL_ZOOM = 12;
    const CENTER_FALLBACK = { lat: 36.3526, lng: -94.2755 };

    let map, infoWindow;
    let markers = {};     // { device: marker }
    let trails = {};      // { device: [LatLng, ...] }
    let trailPolylines = {}; // { device: Polyline }
    let playbackTimer = null;
    let playbackStep = 0;
    let playbackActive = false;
    let timestamps = [];
    let trailHistory = {}; // { timestamp: { device: LatLng } }

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: CENTER_FALLBACK,
        zoom: INITIAL_ZOOM,
        mapTypeId: 'hybrid',
        disableDefaultUI: false,
        gestureHandling: 'greedy'
      });
      infoWindow = new google.maps.InfoWindow();
      fetchTrailData();
    }

    async function fetchTrailData() {
      try {
        const url = `${ENDPOINT}?json=true&since=1h&t=${Date.now()}`;
        const res = await fetch(url);
        const data = await res.json();

        // Group by timestamp
        trailHistory = {}; trails = {}; timestamps = [];

        data.forEach(pt => {
          const ts = pt.timestamp;
          const key = pt.device;
          if (!trailHistory[ts]) trailHistory[ts] = {};
          trailHistory[ts][key] = { lat: pt.latitude, lng: pt.longitude };
          if (!trails[key]) trails[key] = [];
          trails[key].push({ lat: pt.latitude, lng: pt.longitude });
        });

        timestamps = Object.keys(trailHistory).sort();
        document.getElementById('timeSlider').max = timestamps.length - 1;
        drawCurrent();
      } catch (e) {
        console.error(e);
      }
    }

    function drawCurrent() {
      for (let key in trails) {
        const last = trails[key][trails[key].length - 1];
        if (!markers[key]) {
          markers[key] = new google.maps.Marker({
            position: last,
            map: map,
            title: key,
            icon: {
              url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
              scaledSize: new google.maps.Size(48,48),
              anchor: new google.maps.Point(24,48),
              labelOrigin: new google.maps.Point(24,0)
            },
            label: {
              text: key,
              color: '#ffffff',
              fontWeight: 'bold'
            }
          });
          markers[key].addListener('click', () => {
            infoWindow.setContent(`<strong>${key}</strong>`);
            infoWindow.open(map, markers[key]);
          });
        } else {
          markers[key].setPosition(last);
        }

        // Draw polyline
        if (!trailPolylines[key]) {
          trailPolylines[key] = new google.maps.Polyline({
            path: trails[key],
            geodesic: true,
            strokeColor: '#00F',
            strokeOpacity: 0.5,
            strokeWeight: 4,
            map: map
          });
        }
      }
    }

    function toggleTrail() {
      const visible = trailPolylines[Object.keys(trailPolylines)[0]]?.getMap();
      for (let key in trailPolylines) {
        trailPolylines[key].setMap(visible ? null : map);
      }
    }

    function fitBounds() {
      const bounds = new google.maps.LatLngBounds();
      for (let key in markers) bounds.extend(markers[key].getPosition());
      map.fitBounds(bounds);
    }

    function togglePlayback() {
      playbackActive = !playbackActive;
      if (playbackActive) {
        playbackTimer = setInterval(stepPlayback, 500);
      } else {
        clearInterval(playbackTimer);
      }
    }

    function stepPlayback() {
      if (playbackStep >= timestamps.length) {
        clearInterval(playbackTimer);
        playbackActive = false;
        return;
      }
      updatePlaybackMarkers(timestamps[playbackStep]);
      document.getElementById('timeSlider').value = playbackStep;
      playbackStep++;
    }

    function sliderMoved() {
      playbackStep = parseInt(document.getElementById('timeSlider').value);
      updatePlaybackMarkers(timestamps[playbackStep]);
    }

    function updatePlaybackMarkers(ts) {
      const positions = trailHistory[ts];
      for (let key in positions) {
        const pos = positions[key];
        if (markers[key]) {
          markers[key].setPosition(pos);
        }
      }
    }

    window.onload = initMap;
  </script>
</body>
</html>